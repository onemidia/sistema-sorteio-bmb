<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Sorteio Corporativo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome para Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Configuração de Cores Personalizadas (Tailwind Config) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        app: {
                            bg: '#000000',
                            card: '#111111',
                            muted: '#1A1A1A',
                        },
                        txt: {
                            title: '#FFFFFF',
                            body: '#E2E8F0',
                            muted: '#64748B',
                        },
                        border: {
                            light: '#333333',
                        },
                        bmb: {
                            blue: '#0A73B8',
                        },
                        action: {
                            primary: '#000000',
                            hover: '#1F2933',
                        },
                        status: {
                            success: '#22C55E',
                            danger: '#EF4444',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Animação suave para transições de tela */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Estilo para o display numérico */
        .digit-display {
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.1em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* ======================== MODO TELÃO LED ======================== */
        body.fullscreen-mode {
            background-color: #000000 !important;
            overflow: hidden;
        }
        
        /* Esconde elementos desnecessários */
        body.fullscreen-mode aside,
        body.fullscreen-mode header,
        body.fullscreen-mode .lg\:col-span-1, /* Sidebar Histórico */
        body.fullscreen-mode #btn-draw,
        body.fullscreen-mode label,
        body.fullscreen-mode #max-number,
        body.fullscreen-mode .text-txt-muted,
        body.fullscreen-mode img,
        body.fullscreen-mode h3,
        body.fullscreen-mode #fullscreen-btn,
        body.fullscreen-mode #mobile-menu
        {
            display: none !important;
        }

        /* Centraliza o Main */
        body.fullscreen-mode main {
            margin: 0 !important;
            padding: 0 !important;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        body.fullscreen-mode #view-home {
            display: flex !important;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        body.fullscreen-mode .bg-app-card,
        body.fullscreen-mode .bg-app-muted {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        /* Tipografia LED */
        body.fullscreen-mode #raffle-display {
            font-size: 35vh !important;
            font-weight: 900 !important;
            color: #FFD700 !important; /* Amarelo Vibrante */
            text-shadow: 5px 5px 0px #000000, 0 0 30px rgba(255, 215, 0, 0.2) !important;
            line-height: 1;
        }

        body.fullscreen-mode #raffle-item {
            display: block !important;
            background: transparent !important;
            border: none !important;
            color: #FFFFFF !important;
            font-size: 6vh !important;
            font-weight: 700 !important;
            text-align: center;
            width: 100%;
            margin-top: 0;
            text-shadow: 2px 2px 0px #000000;
        }
    </style>
</head>
<body class="bg-app-bg text-txt-body font-sans min-h-screen flex flex-col">

    <!-- ======================== TELA DE LOGIN ======================== -->
    <section id="login-screen" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-app-card p-8 rounded-[16px] shadow-sm w-full max-w-md border border-border-light fade-in">
            <div class="text-center mb-8">
                <!-- Logo Principal na Tela de Login -->
                <img src="logo-bmb.png" alt="BMB Advertising" class="h-16 mx-auto mb-6">
                <h1 class="text-[1.8rem] font-bold text-txt-title">Acesso Restrito</h1>
                <p class="text-txt-muted text-sm">Sistema de Sorteio Inter-Filiais</p>
            </div>

            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-txt-body mb-1">Nome da Filial</label>
                    <input type="text" id="branch-name" 
                        class="w-full p-3 border border-border-light rounded-[10px] focus:outline-none focus:border-bmb-blue transition"
                        placeholder="Ex: BMB Filial Centro">
                </div>
                <div>
                    <label class="block text-sm font-medium text-txt-body mb-1">Código da Filial</label>
                    <input type="text" id="branch-code" required 
                        class="w-full p-3 border border-border-light rounded-[10px] focus:outline-none focus:border-bmb-blue transition"
                        placeholder="Ex: FILIAL01">
                </div>
                <div>
                    <label class="block text-sm font-medium text-txt-body mb-1">Senha de Acesso</label>
                    <input type="password" id="password" required 
                        class="w-full p-3 border border-border-light rounded-[10px] focus:outline-none focus:border-bmb-blue transition"
                        placeholder="••••••••">
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden">
                    Credenciais inválidas.
                </div>
                <button type="submit" 
                    class="w-full bg-action-primary hover:bg-action-hover text-white font-semibold py-4 rounded-full transition duration-200 shadow-none">
                    ENTRAR NO SISTEMA
                </button>
            </form>
            
            <div class="mt-6 text-center text-xs text-txt-muted">
                <p>Dica para teste: Use <strong>FILIAL01</strong> / <strong>123456</strong></p>
            </div>
        </div>
    </section>

    <!-- ======================== DASHBOARD ======================== -->
    <section id="dashboard-screen" class="hidden min-h-screen w-full fade-in bg-app-bg">
        
        <!-- Sidebar (Desktop) -->
        <aside class="hidden md:flex flex-col w-64 bg-[#050505] border-r border-border-light fixed inset-y-0 left-0 z-20">
            <div class="p-6 border-b border-border-light flex items-center justify-center">
                <img src="logo-bmb.png" alt="BMB" class="h-12">
            </div>
            
            <nav class="flex-grow p-4 space-y-2">
                <button onclick="app.navigateTo('home')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-txt-body hover:bg-white/10 hover:text-bmb-blue transition active-nav" data-view="home">
                    <i class="fa-solid fa-ticket w-5"></i> Sorteador
                </button>
                
                <button onclick="app.navigateTo('events')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-txt-body hover:bg-white/10 hover:text-bmb-blue transition" data-view="events">
                    <i class="fa-regular fa-calendar-check w-5"></i> Meus Eventos
                </button>

                <button id="sidebar-admin-btn" onclick="app.navigateTo('admin')" class="hidden nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-txt-body hover:bg-white/10 hover:text-bmb-blue transition" data-view="admin">
                    <i class="fa-solid fa-user-shield w-5"></i> Admin Geral
                </button>
            </nav>

            <div class="p-4 border-t border-border-light">
                <div class="mb-4 px-4">
                    <p class="text-xs text-txt-muted uppercase font-bold mb-1">Logado como</p>
                    <p class="text-sm font-semibold text-txt-title truncate" id="sidebar-branch-name">Filial</p>
                </div>
                <button onclick="app.logout()" class="w-full flex items-center justify-center gap-2 px-4 py-2 text-sm text-status-danger bg-red-50 hover:bg-red-100 rounded-lg transition">
                    <i class="fa-solid fa-right-from-bracket"></i> Sair
                </button>
            </div>
        </aside>

        <!-- Mobile Header -->
        <header class="md:hidden bg-white border-b border-border-light p-4 flex justify-between items-center sticky top-0 z-30">
            <img src="logo-bmb-iniciais.png" alt="BMB" class="h-8">
            <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="text-txt-body p-2">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
        </header>

        <!-- Mobile Menu Dropdown -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-b border-border-light p-4 absolute w-full z-20 shadow-lg">
            <nav class="space-y-2">
                <button onclick="app.navigateTo('home'); document.getElementById('mobile-menu').classList.add('hidden')" class="block w-full text-left px-4 py-3 rounded-lg hover:bg-app-muted">Sorteador</button>
                <button onclick="app.navigateTo('events'); document.getElementById('mobile-menu').classList.add('hidden')" class="block w-full text-left px-4 py-3 rounded-lg hover:bg-app-muted">Meus Eventos</button>
                <button id="mobile-admin-btn" onclick="app.navigateTo('admin'); document.getElementById('mobile-menu').classList.add('hidden')" class="hidden block w-full text-left px-4 py-3 rounded-lg hover:bg-app-muted">Admin</button>
                <button onclick="app.logout()" class="block w-full text-left px-4 py-3 rounded-lg text-status-danger hover:bg-red-50">Sair</button>
            </nav>
        </div>

        <!-- Main Content Area -->
        <main class="md:ml-64 p-4 md:p-8 min-h-screen">
            <!-- Marca D'água Centralizada -->
            <img src="logo-bmb-iniciais.png" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[60%] opacity-5 pointer-events-none z-0">
            
            <!-- VIEW: SORTEADOR (HOME) -->
            <div id="view-home" class="view-section grid grid-cols-1 lg:grid-cols-2 gap-8 fade-in relative z-10 h-[calc(100vh-4rem)]">
                <!-- Área de Sorteio -->
                <div class="flex flex-col gap-6 h-full">
                    <div class="bg-app-card rounded-[16px] shadow-2xl p-8 text-center border border-border-light flex flex-col items-center justify-center h-full relative overflow-hidden">
                        <button id="fullscreen-btn" onclick="app.toggleFullScreenView()" class="absolute top-4 right-4 text-txt-muted hover:text-bmb-blue transition p-2" title="Modo Telão">
                            <i class="fa-solid fa-expand text-xl"></i>
                        </button>
                        <!-- Logo removida daqui para limpar o visual -->
                        <h3 class="text-txt-muted uppercase tracking-[0.2em] text-lg font-bold mb-4">Sorteio em Andamento</h3>
                        
                        <div class="w-full flex-grow flex items-center justify-center">
                            <span id="raffle-display" class="digit-display text-[20vh] lg:text-[35vh] font-[900] text-[#FFD700] block tracking-widest leading-none drop-shadow-[0_0_15px_rgba(255,215,0,0.3)]">
                                000000
                            </span>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl mb-8">
                            <div>
                                <label class="block text-xs uppercase tracking-wider font-bold text-txt-muted mb-2">Prêmio / Item</label>
                                <input type="text" id="raffle-item" placeholder="Ex: iPhone 15" 
                                    class="w-full p-4 bg-app-muted border border-border-light rounded-[12px] focus:outline-none focus:border-bmb-blue transition text-center font-bold text-xl text-white placeholder-gray-600">
                            </div>
                            <div>
                                <label class="block text-xs uppercase tracking-wider font-bold text-txt-muted mb-2">Participantes (Max)</label>
                                <input type="number" id="max-number" value="10000" min="1" 
                                    class="w-full p-4 bg-app-muted border border-border-light rounded-[12px] focus:outline-none focus:border-bmb-blue transition text-center font-mono text-xl text-white">
                            </div>
                        </div>

                        <button id="btn-draw" onclick="app.startRaffle()"
                            class="group relative bg-[#FFD700] hover:bg-[#E6C200] text-black text-2xl font-black uppercase tracking-wider py-6 px-16 rounded-full shadow-[0_0_20px_rgba(255,215,0,0.4)] hover:shadow-[0_0_30px_rgba(255,215,0,0.6)] transition-all duration-200 disabled:opacity-70 disabled:cursor-not-allowed w-full max-w-md transform hover:scale-105">
                            <span id="btn-text">SORTEAR AGORA</span>
                            <span id="btn-loading" class="hidden absolute inset-0 flex items-center justify-center">
                                <i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Sorteando...
                            </span>
                        </button>
                    </div>
                </div>

                <!-- Sidebar de Histórico -->
                <div>
                    <div class="bg-app-card rounded-[16px] shadow-sm border border-border-light h-full flex flex-col max-h-[calc(100vh-100px)]">
                        <div class="p-5 border-b border-border-light bg-app-muted rounded-t-[16px] flex justify-between items-center">
                            <h3 class="font-bold text-xl text-txt-title"><i class="fa-solid fa-clock-rotate-left mr-2"></i> Últimos Sorteios</h3>
                            <span id="history-count" class="bg-white/10 border border-border-light text-white text-sm font-bold px-3 py-1 rounded-full">0</span>
                        </div>
                        <div class="p-4 flex-grow overflow-y-auto" id="history-list">
                            <!-- Itens via JS -->
                        </div>
                        <div class="p-4 border-t border-border-light text-center">
                            <button onclick="app.clearHistory()" class="text-xs text-status-danger hover:underline">Limpar Histórico</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: MEUS EVENTOS -->
            <div id="view-events" class="view-section hidden fade-in max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-txt-title">Gestão de Eventos</h2>
                    <button onclick="document.getElementById('new-event-modal').classList.remove('hidden')" class="bg-bmb-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                        <i class="fa-solid fa-plus mr-2"></i> Novo Evento
                    </button>
                </div>

                <!-- Modal Novo Evento (Inline simplificado) -->
                <div id="new-event-modal" class="hidden mb-6 bg-white p-6 rounded-[16px] border border-border-light shadow-sm">
                    <h3 class="font-bold text-lg mb-4">Cadastrar Novo Evento</h3>
                    <form id="create-event-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="evt-name" placeholder="Nome do Evento (ex: Natal)" required class="p-3 border border-border-light rounded-lg w-full">
                        <input type="text" id="evt-prize" placeholder="Prêmio" required class="p-3 border border-border-light rounded-lg w-full">
                        <input type="number" id="evt-max" placeholder="Max Participantes" required class="p-3 border border-border-light rounded-lg w-full">
                        <div class="md:col-span-3 flex justify-end gap-2 mt-2">
                            <button type="button" onclick="document.getElementById('new-event-modal').classList.add('hidden')" class="px-4 py-2 text-txt-muted hover:text-txt-body">Cancelar</button>
                            <button type="submit" class="bg-status-success text-white px-6 py-2 rounded-lg hover:bg-green-600">Salvar</button>
                        </div>
                    </form>
                </div>

                <!-- Lista de Eventos -->
                <div class="bg-white rounded-[16px] border border-border-light shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-app-muted text-txt-body font-semibold border-b border-border-light">
                            <tr>
                                <th class="p-4">Evento</th>
                                <th class="p-4">Prêmio</th>
                                <th class="p-4">Max</th>
                                <th class="p-4 text-right">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="events-list" class="divide-y divide-border-light">
                            <!-- Preenchido via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: ADMIN -->
            <div id="view-admin" class="view-section hidden fade-in">
                <h2 class="text-2xl font-bold text-txt-title mb-6"><i class="fa-solid fa-user-shield mr-2"></i> Painel Super Admin</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Cadastro Filiais -->
                    <div class="bg-white p-6 rounded-[16px] border border-border-light shadow-sm">
                        <h3 class="font-bold text-lg mb-4">Filiais</h3>
                        <form id="add-branch-form" class="space-y-3 mb-6">
                            <input type="text" id="new-branch-name" placeholder="Nome da Filial" required class="w-full p-3 border border-border-light rounded-lg">
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" id="new-branch-code" placeholder="Código" required class="w-full p-3 border border-border-light rounded-lg uppercase">
                                <input type="text" id="new-branch-pass" placeholder="Senha" required class="w-full p-3 border border-border-light rounded-lg">
                            </div>
                            <button type="submit" class="w-full bg-black text-white py-2 rounded-lg hover:bg-gray-800">Adicionar</button>
                        </form>
                        <div class="overflow-y-auto max-h-[300px]">
                            <table class="w-full text-sm"><tbody id="branches-list" class="divide-y divide-border-light"></tbody></table>
                        </div>
                    </div>

                    <!-- Visualizador de Eventos Admin -->
                    <div class="bg-white p-6 rounded-[16px] border border-border-light shadow-sm">
                        <h3 class="font-bold text-lg mb-4">Eventos por Filial</h3>
                        <p class="text-xs text-txt-muted mb-4">Selecione uma filial na lista ao lado para ver os eventos.</p>
                        <div id="admin-events-list" class="text-sm text-txt-body space-y-2">
                            <!-- Preenchido ao clicar na filial -->
                            <div class="text-center py-8 text-txt-muted">Nenhuma filial selecionada.</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </section>

    <!-- ======================== LÓGICA JAVASCRIPT ======================== -->
    <script>
        // CONFIGURAÇÃO DO SUPABASE
        // Substitua pelas suas credenciais do projeto Supabase
        const SUPABASE_URL = 'https://qbbooteyllyuitjbxfyr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFiYm9vdGV5bGx5dWl0amJ4ZnlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODc0MTksImV4cCI6MjA4NDM2MzQxOX0._VvvR-Hi_Qw1FG1MJwLeF03XMJxgRBCXvJHY-V4c-N0';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        /**
         * Classe Principal da Aplicação
         * Encapsula toda a lógica para evitar poluição do escopo global
         */
        class RaffleApp {
            constructor() {
                // Configurações
                this.maxNumber = 10000; // Valor inicial
                this.animationDuration = 10000; // 10 segundos em ms
                this.storageKeyPrefix = 'raffle_data_';
                
                // Estado
                this.currentUser = null;
                this.isAnimating = false;
                
                // Elementos DOM
                this.screens = {
                    login: document.getElementById('login-screen'),
                    dashboard: document.getElementById('dashboard-screen')
                };
                this.display = document.getElementById('raffle-display');
                this.maxNumberInput = document.getElementById('max-number');
                this.raffleItemInput = document.getElementById('raffle-item');
                this.historyList = document.getElementById('history-list');
                this.historyCount = document.getElementById('history-count');
                this.btnDraw = document.getElementById('btn-draw');
                this.btnText = document.getElementById('btn-text');
                this.btnLoading = document.getElementById('btn-loading');
                this.sidebarAdminBtn = document.getElementById('sidebar-admin-btn');
                this.mobileAdminBtn = document.getElementById('mobile-admin-btn');
                
                this.init();
            }

            init() {
                // Verifica se já existe sessão
                const savedUser = localStorage.getItem('raffle_session');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                    this.showDashboard();
                }

                // Listener do Login
                document.getElementById('login-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.login();
                });

                document.getElementById('add-branch-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.registerBranch();
                });

                document.getElementById('create-event-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createEvent();
                });

                // Atalho ESC para sair do modo tela cheia
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && document.body.classList.contains('fullscreen-mode')) {
                        this.toggleFullScreenView();
                    }
                });
            }

            // --- Autenticação ---

            async login() {
                const codeInput = document.getElementById('branch-code').value.trim().toUpperCase();
                const passInput = document.getElementById('password').value.trim();
                const errorMsg = document.getElementById('login-error');

                // BUSCA APENAS POR CÓDIGO E SENHA
                const { data, error } = await supabaseClient
                    .from('filiais')
                    .select('*')
                    .eq('codigo_filial', codeInput)
                    .eq('senha', passInput);

                if (error) {
                    console.error("Erro:", error.message);
                    return;
                }

                if (data && data.length > 0) {
                    this.currentUser = data[0];
                    localStorage.setItem('raffle_session', JSON.stringify(this.currentUser));
                    this.showDashboard();
                } else {
                    errorMsg.classList.remove('hidden');
                }
            }

            logout() {
                localStorage.removeItem('raffle_session');
                this.currentUser = null;
                this.screens.dashboard.classList.add('hidden');
                this.screens.login.classList.remove('hidden');
                document.getElementById('branch-code').value = '';
                document.getElementById('password').value = '';
            }

            // --- Navegação e Dashboard ---

            showDashboard() {
                this.screens.login.classList.add('hidden');
                this.screens.dashboard.classList.remove('hidden');
                this.screens.dashboard.classList.add('flex'); // Tailwind flex display
                
                document.getElementById('sidebar-branch-name').innerText = this.currentUser.nome_filial;
                
                // Controle de Acesso Admin
                if (this.currentUser.codigo_filial === 'ADMIN') {
                    this.sidebarAdminBtn.classList.remove('hidden');
                    this.sidebarAdminBtn.classList.add('flex');
                    this.mobileAdminBtn.classList.remove('hidden');
                } else {
                    this.sidebarAdminBtn.classList.add('hidden');
                    this.mobileAdminBtn.classList.add('hidden');
                }

                this.navigateTo('home');
                this.renderHistory();
            }

            navigateTo(viewName) {
                // Esconde todas as views
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                // Mostra a desejada
                document.getElementById(`view-${viewName}`).classList.remove('hidden');
                
                // Atualiza estado visual do menu
                document.querySelectorAll('.nav-item').forEach(el => {
                    if(el.dataset.view === viewName) el.classList.add('bg-white/10', 'text-bmb-blue');
                    else el.classList.remove('bg-white/10', 'text-bmb-blue');
                });

                if(viewName === 'events') this.loadEvents();
                if(viewName === 'admin') this.renderBranches();
            }

            // --- Modo Telão ---
            toggleFullScreenView() {
                document.body.classList.toggle('fullscreen-mode');
                
                // Tenta ativar o Fullscreen do navegador para imersão total
                if (document.body.classList.contains('fullscreen-mode')) {
                    document.documentElement.requestFullscreen().catch(e => console.log(e));
                } else {
                    if (document.fullscreenElement) document.exitFullscreen();
                }
            }

            // --- Lógica do Sorteio ---

            startRaffle() {
                if (this.isAnimating) return;
                
                const maxInput = parseInt(this.maxNumberInput.value);
                if (!maxInput || maxInput < 1) {
                    alert("Por favor, insira um número máximo válido.");
                    return;
                }
                this.maxNumber = maxInput;

                this.isAnimating = true;
                this.setLoadingState(true);

                // Intervalo para efeito de "embaralhamento"
                const shuffleInterval = setInterval(() => {
                    const randomTemp = Math.floor(Math.random() * (this.maxNumber + 1));
                    this.display.innerText = this.formatNumber(randomTemp);
                }, 50);

                // Finaliza após 10 segundos
                setTimeout(() => {
                    clearInterval(shuffleInterval);
                    this.finalizeRaffle();
                }, this.animationDuration);
            }

            finalizeRaffle() {
                // Gera o número final real
                // Usando crypto.getRandomValues se disponível para maior aleatoriedade, ou Math.random fallback
                let finalNumber;
                if (window.crypto && window.crypto.getRandomValues) {
                    const array = new Uint32Array(1);
                    window.crypto.getRandomValues(array);
                    // Normaliza para o range 0 - 10000
                    finalNumber = array[0] % (this.maxNumber + 1);
                } else {
                    finalNumber = Math.floor(Math.random() * (this.maxNumber + 1));
                }

                const formattedNumber = this.formatNumber(finalNumber);
                this.display.innerText = formattedNumber;
                
                this.saveResult(formattedNumber);
                this.setLoadingState(false);
                this.isAnimating = false;

                // Dispara Confetes
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                
                // Efeito visual de sucesso (piscar verde)
                this.display.classList.add('text-status-success');
                setTimeout(() => this.display.classList.remove('text-status-success'), 1000);
            }

            // --- Utilitários e Persistência ---

            formatNumber(num) {
                return num.toString().padStart(6, '0');
            }

            setLoadingState(isLoading) {
                if (isLoading) {
                    this.btnDraw.disabled = true;
                    this.maxNumberInput.disabled = true;
                    this.raffleItemInput.disabled = true;
                    this.btnText.classList.add('hidden');
                    this.btnLoading.classList.remove('hidden');
                } else {
                    this.btnDraw.disabled = false;
                    this.maxNumberInput.disabled = false;
                    this.raffleItemInput.disabled = false;
                    this.btnText.classList.remove('hidden');
                    this.btnLoading.classList.add('hidden');
                }
            }

            async saveResult(number) {
                const item = this.raffleItemInput.value.trim();
                
                const { error } = await supabaseClient.from('raffle_history').insert({
                    branch_code: this.currentUser.codigo_filial,
                    number: number,
                    item: item
                });

                if (error) console.error('Erro ao salvar:', error);
                this.renderHistory();
            }

            async deleteResult(id) {
                if(!confirm('Deseja realmente excluir este resultado?')) return;

                const { error } = await supabaseClient.from('raffle_history').delete().eq('id', id);
                if (error) console.error('Erro ao deletar:', error);
                
                this.renderHistory();
            }

            async clearHistory() {
                if(!confirm('Tem certeza que deseja apagar TODO o histórico desta filial?')) return;
                
                const { error } = await supabaseClient.from('raffle_history').delete().eq('branch_code', this.currentUser.codigo_filial);
                if (error) console.error('Erro ao limpar:', error);
                
                this.renderHistory();
            }

            async renderHistory() {
                const { data: history, error } = await supabaseClient
                    .from('raffle_history')
                    .select('*')
                    .eq('branch_code', this.currentUser.codigo_filial)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Erro ao carregar histórico:', error);
                    return;
                }
                
                this.historyCount.innerText = history.length;
                this.historyList.innerHTML = '';

                if (history.length === 0) {
                    this.historyList.innerHTML = `
                        <div class="text-center text-txt-muted py-8 text-sm flex flex-col items-center">
                            <i class="fa-regular fa-folder-open text-2xl mb-2 opacity-50"></i>
                            Nenhum sorteio realizado.
                        </div>`;
                    return;
                }

                history.forEach(item => {
                    const date = new Date(item.created_at).toLocaleString('pt-BR');
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-app-muted p-6 mb-4 rounded-[14px] border border-border-light shadow-sm hover:border-bmb-blue transition-colors';
                    div.innerHTML = `
                        <div>
                            <span class="block font-mono font-black text-4xl text-[#FFD700] tracking-widest mb-1">${item.number}</span>
                            ${item.item ? `<span class="text-lg font-bold text-white mb-1 block uppercase tracking-wide">${item.item}</span>` : ''}
                            <span class="text-xs text-txt-muted">${date}</span>
                        </div>
                        <button onclick="app.deleteResult(${item.id})" class="text-txt-muted hover:text-status-danger transition p-2" title="Excluir">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    `;
                    this.historyList.appendChild(div);
                });
            }

            // --- Funcionalidades Admin ---

            async registerBranch() {
                const name = document.getElementById('new-branch-name').value.trim();
                const code = document.getElementById('new-branch-code').value.trim().toUpperCase();
                const pass = document.getElementById('new-branch-pass').value.trim();

                const { error } = await supabaseClient.from('filiais').insert({
                    codigo_filial: code,
                    senha: pass,
                    nome_filial: name
                });

                if (error) {
                    alert('Erro ao cadastrar: ' + error.message);
                    return;
                }
                
                // Limpar form
                document.getElementById('new-branch-name').value = '';
                document.getElementById('new-branch-code').value = '';
                document.getElementById('new-branch-pass').value = '';
                
                this.renderBranches();
                alert('Filial cadastrada com sucesso!');
            }

            async renderBranches() {
                const tbody = document.getElementById('branches-list');
                tbody.innerHTML = '';
                
                const { data: users, error } = await supabaseClient.from('filiais').select('*').order('nome_filial');
                if (error) return;

                users.forEach(user => {
                    if (user.codigo_filial === 'ADMIN') return; // Não listar o admin
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-3 font-medium text-txt-title cursor-pointer hover:text-bmb-blue" onclick="app.loadAdminEvents('${user.codigo_filial}', '${user.nome_filial}')">
                            ${user.nome_filial} <i class="fa-solid fa-chevron-right text-xs ml-2 opacity-50"></i>
                        </td>
                        <td class="p-3 font-mono text-txt-body text-xs">${user.codigo_filial}</td>
                        <td class="p-3 font-mono text-txt-muted text-xs">****</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            // --- Gestão de Eventos (Filial) ---

            async createEvent() {
                const name = document.getElementById('evt-name').value;
                const prize = document.getElementById('evt-prize').value;
                const max = document.getElementById('evt-max').value;

                const { error } = await supabaseClient.from('eventos').insert({
                    branch_code: this.currentUser.codigo_filial,
                    name: name,
                    prize: prize,
                    max_participants: max
                });

                if(error) alert('Erro ao criar evento: ' + error.message);
                else {
                    document.getElementById('create-event-form').reset();
                    document.getElementById('new-event-modal').classList.add('hidden');
                    this.loadEvents();
                }
            }

            async loadEvents() {
                const tbody = document.getElementById('events-list');
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-txt-muted">Carregando...</td></tr>';

                const { data: events } = await supabaseClient.from('eventos')
                    .select('*')
                    .eq('branch_code', this.currentUser.codigo_filial)
                    .order('created_at', { ascending: false });
                
                tbody.innerHTML = '';
                if(!events || events.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-txt-muted">Nenhum evento cadastrado.</td></tr>';
                    return;
                }

                events.forEach(evt => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-4 font-medium">${evt.name}</td>
                        <td class="p-4 text-txt-muted">${evt.prize}</td>
                        <td class="p-4 font-mono">${evt.max_participants}</td>
                        <td class="p-4 text-right">
                            <button onclick="app.prepareRaffle('${evt.prize}', ${evt.max_participants})" class="bg-action-primary text-white text-xs px-3 py-1 rounded hover:bg-action-hover transition">
                                Sortear <i class="fa-solid fa-arrow-right ml-1"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            prepareRaffle(prize, max) {
                this.raffleItemInput.value = prize;
                this.maxNumberInput.value = max;
                this.navigateTo('home');
            }

            // --- Admin: Ver Eventos da Filial ---
            async loadAdminEvents(branchCode, branchName) {
                const container = document.getElementById('admin-events-list');
                container.innerHTML = `<div class="text-center py-4">Carregando eventos de <strong>${branchName}</strong>...</div>`;

                const { data: events } = await supabaseClient.from('eventos')
                    .select('*')
                    .eq('branch_code', branchCode)
                    .order('created_at', { ascending: false });

                container.innerHTML = `<h4 class="font-bold text-bmb-blue mb-3">Eventos: ${branchName}</h4>`;
                
                if(!events || events.length === 0) {
                    container.innerHTML += '<div class="text-txt-muted text-sm">Nenhum evento encontrado para esta filial.</div>';
                    return;
                }

                events.forEach(evt => {
                    const div = document.createElement('div');
                    div.className = 'p-3 bg-app-muted rounded border border-border-light mb-2';
                    div.innerHTML = `
                        <div class="font-bold text-txt-title">${evt.name}</div>
                        <div class="text-xs text-txt-muted flex justify-between mt-1">
                            <span>Prêmio: ${evt.prize}</span>
                            <span>Max: ${evt.max_participants}</span>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
        }

        // Inicializa a aplicação
        window.app = new RaffleApp();
    </script>
</body>
</html>
