<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Sorteio BMB - Alta Visibilidade</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        app: { bg: '#000000', card: '#111111', muted: '#1A1A1A' },
                        txt: { title: '#FFFFFF', body: '#E2E8F0', muted: '#64748B' },
                        border: { light: '#333333' },
                        bmb: { blue: '#0A73B8' },
                        action: { primary: '#FFD700', hover: '#E6C200' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #000000; color: white; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; }
        .digit-display { font-variant-numeric: tabular-nums; letter-spacing: 0.05em; text-shadow: 0 0 30px rgba(255, 215, 0, 0.2); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #000; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        
        /* Efeito de Flash */
        #flash-overlay {
            position: fixed; inset: 0; background: white; opacity: 0; 
            pointer-events: none; z-index: 9999; transition: opacity 0.1s;
        }

        /* Modo Fullscreen LED */
        body.fullscreen-mode aside { display: none !important; }
        body.fullscreen-mode main { margin-left: 0 !important; width: 100vw; }
        body.fullscreen-mode #history-side-panel { display: none !important; }
        body.fullscreen-mode #raffle-container { width: 100vw !important; }
    </style>
</head>
<body class="flex flex-col md:flex-row">

    <div id="flash-overlay"></div>

    <section id="login-screen" class="fixed inset-0 z-[100] bg-black flex items-center justify-center p-4">
        <div class="bg-app-card p-8 rounded-[24px] border border-border-light w-full max-w-md shadow-2xl">
            <img src="logo-bmb.png" alt="BMB" class="h-16 mx-auto mb-8">
            <form id="login-form" class="space-y-5">
                <input type="text" id="branch-code" placeholder="Código da Filial" required class="w-full p-4 bg-white text-black rounded-xl font-bold">
                <input type="password" id="password" placeholder="Senha" required class="w-full p-4 bg-white text-black rounded-xl font-bold">
                <button type="submit" class="w-full bg-bmb-blue text-white font-black py-4 rounded-full hover:scale-105 transition">ENTRAR</button>
            </form>
        </div>
    </section>

    <aside id="main-sidebar" class="hidden md:flex flex-col w-[15vw] h-screen bg-[#050505] border-r border-border-light p-4 z-50">
        <img src="logo-bmb.png" class="h-10 mx-auto mb-10">
        <nav class="space-y-3 flex-grow">
            <button onclick="app.navigateTo('home')" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-white/10 text-white"><i class="fa-solid fa-ticket"></i> Sorteador</button>
            <button onclick="app.navigateTo('events')" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-white/10 text-white"><i class="fa-solid fa-calendar"></i> Gestão</button>
            <button onclick="app.navigateTo('history')" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-white/10 text-bmb-blue font-bold"><i class="fa-solid fa-list-ul"></i> Histórico Geral</button>
        </nav>
        <div class="pt-4 border-t border-border-light text-center">
            <p class="text-[10px] text-gray-500 uppercase font-black" id="branch-display-name">Filial</p>
            <button onclick="app.logout()" class="text-red-500 text-xs mt-2 hover:underline">Sair do Sistema</button>
        </div>
    </aside>

    <main class="flex-grow h-screen flex flex-col overflow-hidden relative">
        
        <div id="view-home" class="view-section flex flex-row w-full h-full p-6 gap-6">
            
            <div id="raffle-container" class="w-[75%] bg-app-card rounded-[32px] border border-border-light flex flex-col items-center justify-center relative">
                <img src="logo-bmb-iniciais.png" class="h-24 mb-4 opacity-90">
                <h2 class="text-gray-500 tracking-[0.3em] font-black text-xl mb-4 uppercase">Sorteio em Andamento</h2>
                
                <div id="raffle-display" class="digit-display font-[900] text-[#FFD700] select-none leading-none mb-10" style="font-size: clamp(8rem, 16vw, 35vh);">000000</div>
                
                <div class="flex gap-4 w-full max-w-2xl">
                    <input type="text" id="raffle-item" placeholder="Prêmio do Momento" class="flex-grow p-4 bg-white text-black text-center font-black text-2xl rounded-2xl">
                    <input type="number" id="max-number" value="9999" max="9999" class="w-32 p-4 bg-white text-black text-center font-black text-2xl rounded-2xl">
                </div>

                <button id="btn-draw" onclick="app.startRaffle()" class="mt-10 bg-[#FFD700] hover:bg-[#E6C200] text-black font-black text-3xl py-8 px-20 rounded-full shadow-[0_0_50px_rgba(255,215,0,0.3)] transform hover:scale-105 transition">SORTEAR AGORA</button>
            </div>

            <div id="history-side-panel" class="w-[25%] bg-app-card rounded-[32px] border border-border-light flex flex-col overflow-hidden">
                <div class="p-5 border-b border-border-light bg-white/5 font-black text-sm tracking-widest text-center uppercase">Ganhadores Hoje</div>
                <div id="history-list" class="flex-grow overflow-y-auto p-4 space-y-3 custom-scrollbar"></div>
            </div>
        </div>

        <div id="view-events" class="view-section hidden p-10 max-w-5xl mx-auto w-full">
            <h1 class="text-3xl font-black mb-8 border-b border-bmb-blue pb-4">Gestão de Eventos</h1>
            <form id="create-event-form" class="grid grid-cols-3 gap-4 mb-10 bg-app-card p-6 rounded-2xl border border-border-light">
                <div class="flex flex-col"><label class="text-xs font-bold mb-1 text-gray-400">Nome do Evento</label><input type="text" id="evt-name" placeholder="Ex: Sorteio Natal" required class="p-3 rounded-lg text-black font-bold"></div>
                <div class="flex flex-col"><label class="text-xs font-bold mb-1 text-gray-400">Prêmio</label><input type="text" id="evt-prize" placeholder="Ex: iPhone 15" required class="p-3 rounded-lg text-black font-bold"></div>
                <div class="flex flex-col"><label class="text-xs font-bold mb-1 text-gray-400">Máximo Participantes</label><input type="number" id="evt-max" max="9999" placeholder="9999" required class="p-3 rounded-lg text-black font-bold"></div>
                <button type="submit" class="col-span-3 bg-bmb-blue text-white font-black py-3 rounded-xl mt-4">CADASTRAR EVENTO</button>
            </form>
            <div class="bg-app-card rounded-2xl border border-border-light overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-white/10 text-xs font-black uppercase"><tr><th class="p-4">Evento</th><th class="p-4">Prêmio</th><th class="p-4">Participantes</th><th class="p-4 text-right">Ação</th></tr></thead>
                    <tbody id="events-list" class="text-black font-bold bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <div id="view-history" class="view-section hidden p-10 w-full h-full overflow-hidden flex flex-col">
            <h1 class="text-3xl font-black mb-6">Histórico Geral de Sorteios</h1>
            <div class="bg-white rounded-2xl overflow-hidden flex-grow shadow-2xl">
                <div class="overflow-y-auto h-full custom-scrollbar">
                    <table class="w-full text-left text-black">
                        <thead class="bg-gray-100 sticky top-0 font-black text-xs uppercase"><tr><th class="p-4">Data</th><th class="p-4">Filial</th><th class="p-4">Número</th><th class="p-4">Prêmio</th></tr></thead>
                        <tbody id="global-history-list" class="divide-y divide-gray-100 font-bold"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://qbbooteyllyuitjbxfyr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFiYm9vdGV5bGx5dWl0amJ4ZnlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODc0MTksImV4cCI6MjA4NDM2MzQxOX0._VvvR-Hi_Qw1FG1MJwLeF03XMJxgRBCXvJHY-V4c-N0';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        class RaffleApp {
            constructor() {
                this.currentUser = null;
                this.isAnimating = false;
                this.init();
            }

            init() {
                const saved = localStorage.getItem('raffle_session');
                if (saved) { this.currentUser = JSON.parse(saved); this.showDashboard(); }
                document.getElementById('login-form').onsubmit = (e) => { e.preventDefault(); this.login(); };
                document.getElementById('create-event-form').onsubmit = (e) => { e.preventDefault(); this.createEvent(); };
            }

            async login() {
                const code = document.getElementById('branch-code').value.toUpperCase();
                const pass = document.getElementById('password').value;
                const { data } = await supabaseClient.from('filiais').select('*').eq('codigo_filial', code).eq('senha', pass);
                if (data?.length) { this.currentUser = data[0]; localStorage.setItem('raffle_session', JSON.stringify(this.currentUser)); this.showDashboard(); }
                else alert('Erro de login!');
            }

            showDashboard() {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('branch-display-name').innerText = this.currentUser.nome_filial;
                this.navigateTo('home');
                this.renderTodayHistory();
            }

            logout() { localStorage.clear(); location.reload(); }

            navigateTo(view) {
                document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));
                document.getElementById(`view-${view}`).classList.remove('hidden');
                if(view === 'events') this.loadEvents();
                if(view === 'history') this.loadGlobalHistory();
            }

            async startRaffle() {
                if(this.isAnimating) return;
                this.isAnimating = true;
                let duration = 10000;
                let display = document.getElementById('raffle-display');
                let max = parseInt(document.getElementById('max-number').value) || 9999;

                let shuffle = setInterval(() => {
                    display.innerText = Math.floor(Math.random() * (max + 1)).toString().padStart(6, '0');
                }, 50);

                setTimeout(() => {
                    clearInterval(shuffle);
                    const final = Math.floor(Math.random() * (max + 1)).toString().padStart(6, '0');
                    display.innerText = final;
                    this.triggerFlash();
                    this.saveResult(final);
                    confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                    this.isAnimating = false;
                }, duration);
            }

            triggerFlash() {
                const f = document.getElementById('flash-overlay');
                f.style.opacity = '1';
                setTimeout(() => f.style.opacity = '0', 200);
            }

            async saveResult(num) {
                const item = document.getElementById('raffle-item').value;
                await supabaseClient.from('raffle_history').insert({ branch_code: this.currentUser.codigo_filial, number: num, item: item });
                this.renderTodayHistory();
            }

            async renderTodayHistory() {
                const today = new Date().toISOString().split('T')[0];
                const { data } = await supabaseClient.from('raffle_history').select('*').eq('branch_code', this.currentUser.codigo_filial).gte('created_at', today).order('created_at', { ascending: false });
                const list = document.getElementById('history-list');
                list.innerHTML = data.map(h => `
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                        <div class="text-[#FFD700] font-black text-2xl font-mono">${h.number}</div>
                        <div class="text-white text-xs uppercase font-bold mt-1">${h.item || 'Prêmio'}</div>
                    </div>
                `).join('');
            }

            async loadEvents() {
                const { data } = await supabaseClient.from('eventos').select('*').eq('branch_code', this.currentUser.codigo_filial).order('created_at', { ascending: false });
                document.getElementById('events-list').innerHTML = data.map(e => `
                    <tr><td class="p-4">${e.name}</td><td class="p-4">${e.prize}</td><td class="p-4 font-mono">${e.max_participants}</td>
                    <td class="p-4 text-right"><button onclick="app.setRaffle('${e.prize}', ${e.max_participants})" class="bg-black text-white text-[10px] px-3 py-1 rounded-full uppercase">Sortear</button></td></tr>
                `).join('');
            }

            setRaffle(p, m) { document.getElementById('raffle-item').value = p; document.getElementById('max-number').value = m; this.navigateTo('home'); }

            async createEvent() {
                const name = document.getElementById('evt-name').value;
                const prize = document.getElementById('evt-prize').value;
                const max = document.getElementById('evt-max').value;
                await supabaseClient.from('eventos').insert({ branch_code: this.currentUser.codigo_filial, name, prize, max_participants: max });
                document.getElementById('create-event-form').reset();
                this.loadEvents();
            }

            async loadGlobalHistory() {
                const { data } = await supabaseClient.from('raffle_history').select('*').order('created_at', { ascending: false }).limit(200);
                document.getElementById('global-history-list').innerHTML = data.map(h => `
                    <tr><td class="p-4 text-gray-400 text-xs">${new Date(h.created_at).toLocaleString()}</td><td class="p-4 text-bmb-blue">${h.branch_code}</td><td class="p-4 text-2xl font-black">${h.number}</td><td class="p-4">${h.item || '-'}</td></tr>
                `).join('');
            }
        }
        window.app = new RaffleApp();
    </script>
</body>
</html>