<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Sorteio Corporativo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome para Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Configuração de Cores Personalizadas (Tailwind Config) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        app: {
                            bg: '#F3F6F9',
                            card: '#FFFFFF',
                            muted: '#F8FAFC',
                        },
                        txt: {
                            title: '#0F172A',
                            body: '#475569',
                            muted: '#94A3B8',
                        },
                        border: {
                            light: '#E2E8F0',
                        },
                        bmb: {
                            blue: '#0A73B8',
                        },
                        action: {
                            primary: '#000000',
                            hover: '#1F2933',
                        },
                        status: {
                            success: '#22C55E',
                            danger: '#EF4444',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Animação suave para transições de tela */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Estilo para o display numérico */
        .digit-display {
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.1em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-app-bg text-txt-body font-sans min-h-screen flex flex-col">

    <!-- ======================== TELA DE LOGIN ======================== -->
    <section id="login-screen" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-app-card p-8 rounded-[16px] shadow-sm w-full max-w-md border border-border-light fade-in">
            <div class="text-center mb-8">
                <!-- Logo Principal na Tela de Login -->
                <img src="logo-bmb.png" alt="BMB Advertising" class="h-16 mx-auto mb-6">
                <h1 class="text-[1.8rem] font-bold text-txt-title">Acesso Restrito</h1>
                <p class="text-txt-muted text-sm">Sistema de Sorteio Inter-Filiais</p>
            </div>

            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-txt-body mb-1">Nome da Filial</label>
                    <input type="text" id="branch-name" required 
                        class="w-full p-3 border border-border-light rounded-[10px] focus:outline-none focus:border-bmb-blue transition"
                        placeholder="Ex: BMB Filial Centro">
                </div>
                <div>
                    <label class="block text-sm font-medium text-txt-body mb-1">Código da Filial</label>
                    <input type="text" id="branch-code" required 
                        class="w-full p-3 border border-border-light rounded-[10px] focus:outline-none focus:border-bmb-blue transition"
                        placeholder="Ex: FILIAL01">
                </div>
                <div>
                    <label class="block text-sm font-medium text-txt-body mb-1">Senha de Acesso</label>
                    <input type="password" id="password" required 
                        class="w-full p-3 border border-border-light rounded-[10px] focus:outline-none focus:border-bmb-blue transition"
                        placeholder="••••••••">
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden">
                    Credenciais inválidas.
                </div>
                <button type="submit" 
                    class="w-full bg-action-primary hover:bg-action-hover text-white font-semibold py-4 rounded-full transition duration-200 shadow-none">
                    ENTRAR NO SISTEMA
                </button>
            </form>
            
            <div class="mt-6 text-center text-xs text-txt-muted">
                <p>Dica para teste: Use <strong>FILIAL01</strong> / <strong>123456</strong></p>
            </div>
        </div>
    </section>

    <!-- ======================== DASHBOARD ======================== -->
    <section id="dashboard-screen" class="hidden flex-col min-h-screen w-full fade-in">
        
        <!-- Header -->
        <header class="bg-bmb-blue text-white shadow-sm">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <!-- Logo no Header -->
                    <img src="logo-bmb.png" alt="BMB" class="h-10 bg-white rounded p-1">
                    <div>
                        <h2 class="font-bold text-lg leading-tight" id="header-branch-name">Filial Desconhecida</h2>
                        <span class="text-xs text-white/80">Painel Administrativo</span>
                    </div>
                </div>
                <button onclick="app.logout()" class="text-sm bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg transition flex items-center gap-2">
                    <i class="fa-solid fa-right-from-bracket"></i> Sair
                </button>
            </div>
        </header>

        <!-- Conteúdo Principal -->
        <main class="flex-grow container mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Área de Sorteio (Esquerda/Centro) -->
            <div class="lg:col-span-2 flex flex-col gap-6">
                <div class="bg-app-card rounded-[16px] shadow-sm p-8 text-center border border-border-light flex flex-col items-center justify-center h-full min-h-[400px]">
                    
                    <!-- Logo Initials (BMB) acima do texto -->
                    <img src="logo-bmb-iniciais.png" alt="BMB Logo" class="h-20 mb-4">
                    <h3 class="text-txt-muted uppercase tracking-widest text-sm font-semibold mb-6">Número Sorteado</h3>
                    
                    <!-- Display do Número -->
                    <div class="bg-app-muted rounded-[14px] p-8 mb-8 w-full max-w-xl">
                        <span id="raffle-display" class="digit-display text-6xl md:text-[4rem] font-bold text-action-primary block tracking-[6px]">
                            000000
                        </span>
                    </div>

                    <!-- Configuração do Item -->
                    <div class="mb-4 w-full max-w-xs">
                        <label for="raffle-item" class="block text-sm font-medium text-txt-muted mb-1">Item a ser Sorteado</label>
                        <input type="text" id="raffle-item" placeholder="Ex: iPhone 15, Vale Compras..." 
                            class="w-full p-3 border border-border-light rounded-[10px] focus:outline-none focus:border-bmb-blue transition text-center text-lg text-txt-title">
                    </div>

                    <!-- Configuração do Limite -->
                    <div class="mb-6 w-full max-w-xs">
                        <label for="max-number" class="block text-sm font-medium text-txt-muted mb-1">Quantidade de Participantes (Máximo)</label>
                        <input type="number" id="max-number" value="10000" min="1" 
                            class="w-full p-3 border border-border-light rounded-[10px] focus:outline-none focus:border-bmb-blue transition text-center text-lg font-mono text-txt-title">
                    </div>

                    <!-- Botão de Ação -->
                    <button id="btn-draw" onclick="app.startRaffle()"
                        class="group relative bg-action-primary hover:bg-action-hover text-white text-xl font-semibold py-4 px-12 rounded-full shadow-none transition-all duration-200 disabled:opacity-70 disabled:cursor-not-allowed w-full max-w-xs">
                        <span id="btn-text">SORTEAR AGORA</span>
                        <span id="btn-loading" class="hidden absolute inset-0 flex items-center justify-center">
                            <i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Sorteando...
                        </span>
                    </button>
                    
                    <p class="mt-4 text-txt-muted text-sm">
                        Sorteando entre 0 e o número definido acima.
                    </p>
                </div>
            </div>

            <!-- Sidebar de Resultados (Direita) -->
            <div class="lg:col-span-1">
                <div class="bg-app-card rounded-[16px] shadow-sm border border-border-light h-full flex flex-col">
                    <div class="p-5 border-b border-border-light bg-app-muted rounded-t-[16px] flex justify-between items-center">
                        <h3 class="font-bold text-txt-title"><i class="fa-solid fa-list-ol mr-2"></i> Histórico</h3>
                        <span id="history-count" class="bg-border-light text-txt-body text-xs font-bold px-2 py-1 rounded-full">0</span>
                    </div>
                    
                    <div class="p-4 flex-grow overflow-y-auto max-h-[500px]" id="history-list">
                        <!-- Itens serão inseridos aqui via JS -->
                        <div class="text-center text-txt-muted py-8 text-sm">
                            Nenhum sorteio realizado ainda.
                        </div>
                    </div>
                    
                    <div class="p-4 border-t border-border-light bg-app-muted rounded-b-[16px] text-center">
                        <button onclick="app.clearHistory()" class="text-xs text-status-danger hover:text-red-700 font-medium">
                            Limpar todo o histórico
                        </button>
                    </div>
                </div>
            </div>

        </main>

        <footer class="bg-app-card border-t border-border-light py-4 text-center text-txt-muted text-sm">
            &copy; 2026 Sistema Corporativo. Todos os direitos reservados BMB Advertising Brasil.
        </footer>
    </section>

    <!-- ======================== TELA DE ADMIN (SUPER USER) ======================== -->
    <section id="admin-screen" class="hidden flex-col min-h-screen w-full fade-in bg-app-bg">
        <header class="bg-txt-title text-white shadow-sm">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h2 class="font-bold text-lg"><i class="fa-solid fa-user-shield mr-2"></i> Painel do Super Admin</h2>
                <button onclick="app.toggleAdminScreen()" class="text-sm bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg transition flex items-center gap-2">
                    <i class="fa-solid fa-arrow-left"></i> Voltar ao Dashboard
                </button>
            </div>
        </header>
        <main class="flex-grow container mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Coluna 1: Gestão de Filiais -->
            <div class="bg-app-card rounded-[16px] shadow-sm p-6 border border-border-light">
                <h3 class="font-bold text-xl text-txt-title mb-6 border-b border-border-light pb-2">Cadastrar Nova Filial</h3>
                <form id="add-branch-form" class="space-y-4 mb-8">
                    <input type="text" id="new-branch-name" placeholder="Nome da Filial" required class="w-full p-3 border border-border-light rounded-[10px] focus:outline-none focus:border-bmb-blue">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="new-branch-code" placeholder="Código (ex: FILIAL99)" required class="w-full p-3 border border-border-light rounded-[10px] focus:outline-none focus:border-bmb-blue uppercase">
                        <input type="text" id="new-branch-pass" placeholder="Senha" required class="w-full p-3 border border-border-light rounded-[10px] focus:outline-none focus:border-bmb-blue">
                    </div>
                    <button type="submit" class="w-full bg-status-success hover:bg-green-700 text-white font-bold py-2 rounded-[10px] transition shadow-sm">
                        <i class="fa-solid fa-plus mr-2"></i> Adicionar Filial
                    </button>
                </form>

                <h3 class="font-bold text-lg text-txt-title mb-4">Filiais Cadastradas</h3>
                <div class="overflow-y-auto max-h-[400px] border border-border-light rounded-[10px]">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-app-muted text-txt-body font-bold">
                            <tr>
                                <th class="p-3">Nome</th>
                                <th class="p-3">Código</th>
                                <th class="p-3">Senha</th>
                            </tr>
                        </thead>
                        <tbody id="branches-list" class="divide-y divide-border-light"></tbody>
                    </table>
                </div>
            </div>

            <!-- Coluna 2: Relatório Geral -->
            <div class="bg-app-card rounded-[16px] shadow-sm p-6 border border-border-light">
                <div class="flex justify-between items-center mb-4 border-b border-border-light pb-2">
                    <h3 class="font-bold text-xl text-txt-title">Relatório Geral de Sorteios</h3>
                    <button onclick="app.renderGlobalHistory()" class="text-xs bg-border-light hover:bg-gray-300 px-3 py-1 rounded transition"><i class="fa-solid fa-rotate mr-1"></i> Atualizar</button>
                </div>
                <div class="overflow-y-auto max-h-[600px] border border-border-light rounded-[10px]">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-app-muted text-txt-body font-bold">
                            <tr>
                                <th class="p-3">Filial</th>
                                <th class="p-3">Prêmio</th>
                                <th class="p-3">Número</th>
                                <th class="p-3">Data/Hora</th>
                            </tr>
                        </thead>
                        <tbody id="global-history-list" class="divide-y divide-border-light"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </section>

    <!-- ======================== LÓGICA JAVASCRIPT ======================== -->
    <script>
        // CONFIGURAÇÃO DO SUPABASE
        // Substitua pelas suas credenciais do projeto Supabase
        const SUPABASE_URL = 'https://qbbooteyllyuitjbxfyr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFiYm9vdGV5bGx5dWl0amJ4ZnlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODc0MTksImV4cCI6MjA4NDM2MzQxOX0._VvvR-Hi_Qw1FG1MJwLeF03XMJxgRBCXvJHY-V4c-N0';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        /**
         * Classe Principal da Aplicação
         * Encapsula toda a lógica para evitar poluição do escopo global
         */
        class RaffleApp {
            constructor() {
                // Configurações
                this.maxNumber = 10000; // Valor inicial
                this.animationDuration = 10000; // 10 segundos em ms
                this.storageKeyPrefix = 'raffle_data_';
                
                // Estado
                this.currentUser = null;
                this.isAnimating = false;
                
                // Elementos DOM
                this.screens = {
                    login: document.getElementById('login-screen'),
                    dashboard: document.getElementById('dashboard-screen'),
                    admin: document.getElementById('admin-screen')
                };
                this.display = document.getElementById('raffle-display');
                this.maxNumberInput = document.getElementById('max-number');
                this.raffleItemInput = document.getElementById('raffle-item');
                this.historyList = document.getElementById('history-list');
                this.historyCount = document.getElementById('history-count');
                this.btnDraw = document.getElementById('btn-draw');
                this.btnText = document.getElementById('btn-text');
                this.btnLoading = document.getElementById('btn-loading');
                this.adminBtn = document.getElementById('admin-btn');
                
                this.init();
            }

            init() {
                // Verifica se já existe sessão
                const savedUser = localStorage.getItem('raffle_session');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                    this.showDashboard();
                }

                // Listener do Login
                document.getElementById('login-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.login();
                });

                document.getElementById('add-branch-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.registerBranch();
                });
            }

            // --- Autenticação ---

            async login() {
                const nameInput = document.getElementById('branch-name').value.trim();
                const codeInput = document.getElementById('branch-code').value.trim().toUpperCase();
                const passInput = document.getElementById('password').value.trim();
                const errorMsg = document.getElementById('login-error');

                console.log("Tentando login...", { code: codeInput, pass: passInput });

                // Consulta ao Supabase
                const { data: user, error } = await supabase
                    .from('filiais')
                    .select('*')
                    .eq('codigo_filial', codeInput)
                    .eq('senha', passInput)
                    .maybeSingle();

                if (error) {
                    console.error("Erro Supabase:", error);
                    alert("Erro ao conectar no banco: " + error.message);
                    return;
                }
                
                if (!user) {
                    console.warn("Usuário não encontrado. Verifique se o RLS está desativado no Supabase.");
                }

                if (user) {
                    // Atualiza o nome da filial com o que foi digitado no input, se houver
                    if (nameInput && nameInput !== user.nome_filial) {
                        await supabase.from('filiais').update({ nome_filial: nameInput }).eq('id', user.id);
                        user.nome_filial = nameInput;
                    }
                    
                    this.currentUser = user;
                    localStorage.setItem('raffle_session', JSON.stringify(user));
                    errorMsg.classList.add('hidden');
                    this.showDashboard();
                } else {
                    errorMsg.classList.remove('hidden');
                }
            }

            logout() {
                localStorage.removeItem('raffle_session');
                this.currentUser = null;
                this.screens.dashboard.classList.add('hidden');
                this.screens.admin.classList.add('hidden');
                this.screens.login.classList.remove('hidden');
                document.getElementById('branch-code').value = '';
                document.getElementById('password').value = '';
            }

            showDashboard() {
                this.screens.login.classList.add('hidden');
                this.screens.dashboard.classList.remove('hidden');
                this.screens.dashboard.classList.add('flex'); // Tailwind flex display
                
                document.getElementById('header-branch-name').innerText = this.currentUser.nome_filial;
                
                // Controle de Acesso Admin
                if (this.currentUser.codigo_filial === 'ADMIN') {
                    this.adminBtn.classList.remove('hidden');
                    this.adminBtn.classList.add('flex');
                } else {
                    this.adminBtn.classList.add('hidden');
                    this.adminBtn.classList.remove('flex');
                }

                this.renderHistory();
            }

            // --- Lógica do Sorteio ---

            startRaffle() {
                if (this.isAnimating) return;
                
                const maxInput = parseInt(this.maxNumberInput.value);
                if (!maxInput || maxInput < 1) {
                    alert("Por favor, insira um número máximo válido.");
                    return;
                }
                this.maxNumber = maxInput;

                this.isAnimating = true;
                this.setLoadingState(true);

                // Intervalo para efeito de "embaralhamento"
                const shuffleInterval = setInterval(() => {
                    const randomTemp = Math.floor(Math.random() * (this.maxNumber + 1));
                    this.display.innerText = this.formatNumber(randomTemp);
                }, 50);

                // Finaliza após 10 segundos
                setTimeout(() => {
                    clearInterval(shuffleInterval);
                    this.finalizeRaffle();
                }, this.animationDuration);
            }

            finalizeRaffle() {
                // Gera o número final real
                // Usando crypto.getRandomValues se disponível para maior aleatoriedade, ou Math.random fallback
                let finalNumber;
                if (window.crypto && window.crypto.getRandomValues) {
                    const array = new Uint32Array(1);
                    window.crypto.getRandomValues(array);
                    // Normaliza para o range 0 - 10000
                    finalNumber = array[0] % (this.maxNumber + 1);
                } else {
                    finalNumber = Math.floor(Math.random() * (this.maxNumber + 1));
                }

                const formattedNumber = this.formatNumber(finalNumber);
                this.display.innerText = formattedNumber;
                
                this.saveResult(formattedNumber);
                this.setLoadingState(false);
                this.isAnimating = false;
                
                // Efeito visual de sucesso (piscar verde)
                this.display.classList.add('text-status-success');
                setTimeout(() => this.display.classList.remove('text-status-success'), 1000);
            }

            // --- Utilitários e Persistência ---

            formatNumber(num) {
                return num.toString().padStart(6, '0');
            }

            setLoadingState(isLoading) {
                if (isLoading) {
                    this.btnDraw.disabled = true;
                    this.maxNumberInput.disabled = true;
                    this.raffleItemInput.disabled = true;
                    this.btnText.classList.add('hidden');
                    this.btnLoading.classList.remove('hidden');
                } else {
                    this.btnDraw.disabled = false;
                    this.maxNumberInput.disabled = false;
                    this.raffleItemInput.disabled = false;
                    this.btnText.classList.remove('hidden');
                    this.btnLoading.classList.add('hidden');
                }
            }

            async saveResult(number) {
                const item = this.raffleItemInput.value.trim();
                
                const { error } = await supabase.from('raffle_history').insert({
                    branch_code: this.currentUser.codigo_filial,
                    number: number,
                    item: item
                });

                if (error) console.error('Erro ao salvar:', error);
                this.renderHistory();
            }

            async deleteResult(id) {
                if(!confirm('Deseja realmente excluir este resultado?')) return;

                const { error } = await supabase.from('raffle_history').delete().eq('id', id);
                if (error) console.error('Erro ao deletar:', error);
                
                this.renderHistory();
            }

            async clearHistory() {
                if(!confirm('Tem certeza que deseja apagar TODO o histórico desta filial?')) return;
                
                const { error } = await supabase.from('raffle_history').delete().eq('branch_code', this.currentUser.codigo_filial);
                if (error) console.error('Erro ao limpar:', error);
                
                this.renderHistory();
            }

            async renderHistory() {
                const { data: history, error } = await supabase
                    .from('raffle_history')
                    .select('*')
                    .eq('branch_code', this.currentUser.codigo_filial)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Erro ao carregar histórico:', error);
                    return;
                }
                
                this.historyCount.innerText = history.length;
                this.historyList.innerHTML = '';

                if (history.length === 0) {
                    this.historyList.innerHTML = `
                        <div class="text-center text-txt-muted py-8 text-sm flex flex-col items-center">
                            <i class="fa-regular fa-folder-open text-2xl mb-2 opacity-50"></i>
                            Nenhum sorteio realizado.
                        </div>`;
                    return;
                }

                history.forEach(item => {
                    const date = new Date(item.created_at).toLocaleString('pt-BR');
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-app-card p-3 mb-2 rounded-[10px] border border-border-light shadow-sm hover:shadow-md transition-shadow';
                    div.innerHTML = `
                        <div>
                            <span class="block font-mono font-bold text-lg text-txt-title tracking-wider">${item.number}</span>
                            ${item.item ? `<span class="text-xs font-semibold text-bmb-blue mb-1 block uppercase">${item.item}</span>` : ''}
                            <span class="text-xs text-txt-muted">${date}</span>
                        </div>
                        <button onclick="app.deleteResult(${item.id})" class="text-txt-muted hover:text-status-danger transition p-2" title="Excluir">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    `;
                    this.historyList.appendChild(div);
                });
            }

            // --- Funcionalidades Admin ---

            toggleAdminScreen() {
                if (this.screens.admin.classList.contains('hidden')) {
                    this.screens.dashboard.classList.add('hidden');
                    this.screens.dashboard.classList.remove('flex');
                    this.screens.admin.classList.remove('hidden');
                    this.screens.admin.classList.add('flex');
                    this.renderBranches();
                    this.renderGlobalHistory();
                } else {
                    this.screens.admin.classList.add('hidden');
                    this.screens.admin.classList.remove('flex');
                    this.showDashboard();
                }
            }

            async registerBranch() {
                const name = document.getElementById('new-branch-name').value.trim();
                const code = document.getElementById('new-branch-code').value.trim().toUpperCase();
                const pass = document.getElementById('new-branch-pass').value.trim();

                const { error } = await supabase.from('filiais').insert({
                    codigo_filial: code,
                    senha: pass,
                    nome_filial: name
                });

                if (error) {
                    alert('Erro ao cadastrar: ' + error.message);
                    return;
                }
                
                // Limpar form
                document.getElementById('new-branch-name').value = '';
                document.getElementById('new-branch-code').value = '';
                document.getElementById('new-branch-pass').value = '';
                
                this.renderBranches();
                alert('Filial cadastrada com sucesso!');
            }

            async renderBranches() {
                const tbody = document.getElementById('branches-list');
                tbody.innerHTML = '';
                
                const { data: users, error } = await supabase.from('filiais').select('*').order('nome_filial');
                if (error) return;

                users.forEach(user => {
                    if (user.codigo_filial === 'ADMIN') return; // Não listar o admin
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-3 font-medium text-txt-title">${user.nome_filial}</td>
                        <td class="p-3 font-mono text-txt-body">${user.codigo_filial}</td>
                        <td class="p-3 font-mono text-txt-muted">****</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            async renderGlobalHistory() {
                const tbody = document.getElementById('global-history-list');
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Carregando...</td></tr>';
                
                // Busca histórico e filiais
                const { data: history } = await supabase.from('raffle_history').select('*').order('created_at', { ascending: false });
                const { data: branches } = await supabase.from('filiais').select('codigo_filial, nome_filial');
                
                // Mapa de códigos para nomes
                const branchMap = {};
                if (branches) branches.forEach(b => branchMap[b.codigo_filial] = b.nome_filial);

                tbody.innerHTML = '';

                if (history) {
                    history.forEach(item => {
                    const date = new Date(item.created_at).toLocaleString('pt-BR');
                    const branchName = branchMap[item.branch_code] || item.branch_code;
                    
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-app-muted';
                    tr.innerHTML = `
                        <td class="p-3 text-txt-title font-medium">${branchName}</td>
                        <td class="p-3 text-sm text-txt-body">${item.item || '-'}</td>
                        <td class="p-3 font-mono font-bold text-lg">${item.number}</td>
                        <td class="p-3 text-txt-muted text-xs">${date}</td>
                    `;
                    tbody.appendChild(tr);
                });
                }
            }
        }

        // Inicializa a aplicação
        window.app = new RaffleApp();
    </script>
</body>
</html>
